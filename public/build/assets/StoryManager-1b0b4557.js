import{o as r,k as l,n as e,a1 as b,L as m,N as d,Y as g,M as a,F as c,p as u,a9 as _,K as f,a3 as v,a0 as h,a8 as k,H as w,O as $,U as C,W as j,j as V,l as I}from"./index.es-c4852431.js";import{P as M}from"./Pagination-b758f7ed.js";/* empty css                                                                  */import{_ as U}from"./_plugin-vue_export-helper-c27b6911.js";/* empty css                                                   */const n=s=>(C("data-v-f0be18d5"),s=s(),j(),s),L=n(()=>e("h2",{class:"mb-2"},"Истории",-1)),F={class:"modal fade",id:"storyModal",tabindex:"-1","aria-labelledby":"storyModalLabel","aria-hidden":"true"},P={class:"modal-dialog modal-dialog-centered modal-fullscreen"},T={class:"modal-header"},O={class:"modal-title",id:"storyModalLabel"},z={class:"modal-body"},B={class:"form-floating mb-2"},E=n(()=>e("label",{for:"title"},"Заголовок",-1)),N={class:"mb-2"},A=n(()=>e("label",{class:"form-label"},"Миниатюра",-1)),q={key:0,class:"img-thumbnail w-100 mb-2"},D={class:"mb-2"},R=n(()=>e("label",{class:"form-label"},"Изображение истории",-1)),J={class:"img-thumbnail w-100 mb-2"},W={class:"form-floating mb-2"},G=n(()=>e("label",{for:"description"},"Описание",-1)),H={class:"form-floating mb-2"},K=n(()=>e("label",{for:"title"},[e("i",{class:"fa-solid fa-link"}),u(" Ссылка")],-1)),Y={key:0,class:"form-floating mb-2"},Q=["value"],X=n(()=>e("label",{for:"link_type"},"Тип ссылки",-1)),Z={class:"modal-footer"},x={class:"form-check form-switch mb-2"},tt={class:"form-check-label",for:"script-settings-can_use_cash"},et=n(()=>e("button",{type:"submit",class:"btn btn-primary p-2 w-100"},"Сохранить",-1)),st={key:0,class:"alert alert-light d-flex flex-column align-items-center justify-content-center"},ot=n(()=>e("div",{class:"spinner-border text-primary my-3",role:"status"},[e("span",{class:"visually-hidden"},"Loading...")],-1)),it={class:"row row-cols-1 row-cols-md-1 g-1"},rt={class:"card h-100"},lt={class:"card-body text-center"},at=["onClick"],nt=["src","alt"],dt={class:"card-title mt-3"},ct={class:"card-text"},mt={class:"card-footer d-flex flex-column align-items-center"},ut=["onClick"],ht={class:"modal-dialog modal-dialog-centered w-100 mw-100 m-0 h-100 mh-100"},pt={class:"modal-content bg-transparent border-0 h-100 position-relative"},yt={class:"progress position-absolute top-0 start-0 end-0",style:{height:"4px","z-index":"10"}},gt=["src"],bt={class:"text-white p-3 bg-black bg-opacity-50 position-absolute bottom-0 start-0 end-0"},ft={class:"mb-1"},St={class:"mb-2"},_t=["href"],vt={key:0,class:"row"},kt={class:"col-12"},wt={name:"AdminPanel",data(){return{currentStory:null,progress:0,timer:null,loadingStories:!1,stories:[],stories_paginate_object:null,formStory:{title:null,need_auto_send_stories:!0,thumbnail:null,image:null,description:null,link:null,link_type:"product"},link_types:[{key:"product",title:"Открывает товар в магазине"},{key:"bot",title:"Открывает раздел бота"},{key:"url",title:"Переход на внешнюю страницу"}],isEditing:!1,useThumbnailFile:!0,useImageFile:!0,viewedStories:JSON.parse(localStorage.getItem("viewedStories"))||[]}},mounted(){this.loadStoriesList()},methods:{goToProductLink(s){try{const i=new URL(s).searchParams.get("start"),o=atob(i).match(/^001slug(\d+)product(\d+)$/);o||this.$router.push({name:"CatalogV2"});const y=o[2];this.$router.push({name:"ProductV2",params:{productId:y}})}catch{this.$router.push({name:"CatalogV2"})}},openStory(s){this.currentStory=s,this.progress=0,this.startTimer(),this.markAsViewed(this.stories[s].id)},closeStory(){this.currentStory=null,this.progress=0,clearInterval(this.timer)},nextStory(){this.currentStory<this.stories.length-1?(this.currentStory++,this.progress=0,this.markAsViewed(this.stories[this.currentStory].id),this.startTimer()):this.closeStory()},startTimer(){clearInterval(this.timer),this.timer=setInterval(()=>{this.progress+=2,this.progress>=100&&this.nextStory()},100)},loadStoriesList(s=1){return this.loadingStories=!0,this.$store.dispatch("loadStories",{page:s,size:20}).then(()=>{this.stories=this.$store.getters.getStories,this.stories_paginate_object=this.$store.getters.getStoriesPaginateObject,this.loadingStories=!1}).catch(()=>{this.loadingStories=!1})},nextStories(s){this.loadStoriesList(s)},startCreateStory(){this.formStory={title:null,thumbnail:null,image:null,description:null},this.isEditing=!1,this.useThumbnailFile=!0,this.useImageFile=!0},saveStory(){let s=new FormData;Object.keys(this.formStory).forEach(t=>{const i=this.formStory[t]||"";typeof i=="object"?s.append(t,JSON.stringify(i)):s.append(t,i)}),s.append("media_thumbnail",this.useThumbnailFile),s.append("media_image",this.useImageFile),s.append("thumbnail[]",this.formStory.thumbnail),s.append("image[]",this.formStory.image),this.$store.dispatch("saveStory",{storyForm:s}).then(()=>{this.startCreateStory(),this.closeModal(),this.$notify({title:"Истории",text:"История успешно сохранена",type:"success"}),document.getElementById("story-form").reset(),this.loadStoriesList()}).catch(()=>{this.$notify({title:"Истории",text:"Ошибка сохранения истории",type:"error"})})},cancelForm(){this.startCreateStory(),this.closeModal()},handleThumbnailUpload(s,t){const i=s.target.files[0];i&&i.size<=5*1024*1024?this.formStory[t]=i:(alert("Размер файла миниатюры не должен превышать 5 МБ"),s.target.value=null)},getPhoto(s){return{imageUrl:URL.createObjectURL(s)}},handleImageUpload(s){const t=s.target.files[0];t&&t.size<=5*1024*1024?this.formStory.image=t:(alert("Размер изображения не должен превышать 5 МБ"),s.target.value=null)},deleteStory(s){this.$store.dispatch("deleteStory",{id:s}).then(()=>{this.$notify({title:"Истории",text:"История успешно удалена",type:"success"}),this.loadStoriesList()}).catch(()=>{this.$notify({title:"Истории",text:"Ошибка удаления истории",type:"error"})})},duplicateStory(s){const t={...s,id:Date.now(),title:`${s.title} (Copy)`};this.$emit("create-story",t)},viewStory(s){this.$emit("view-story",s)},isStoryViewed(s){return this.viewedStories.includes(s)},closeModal(){const s=document.getElementById("storyModal"),t=bootstrap.Modal.getInstance(s);t&&t.hide()}}},$t=Object.assign(wt,{setup(s){return(t,i)=>{const p=$("lazy");return r(),l(c,null,[L,e("button",{type:"button",class:"btn btn-success p-3 w-100 mb-2","data-bs-toggle":"modal","data-bs-target":"#storyModal",onClick:i[0]||(i[0]=(...o)=>t.startCreateStory&&t.startCreateStory(...o))}," Создать новую историю "),e("div",F,[e("div",P,[e("form",{class:"modal-content",id:"story-form",onSubmit:i[9]||(i[9]=b((...o)=>t.saveStory&&t.saveStory(...o),["prevent"]))},[e("div",T,[e("h5",O,m(t.isEditing?"Редактировать историю":"Создать историю"),1),e("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Закрыть",onClick:i[1]||(i[1]=(...o)=>t.cancelForm&&t.cancelForm(...o))})]),e("div",z,[e("div",B,[d(e("input",{"onUpdate:modelValue":i[2]||(i[2]=o=>t.formStory.title=o),type:"text",class:"form-control",id:"title",placeholder:"Введите заголовок",required:""},null,512),[[g,t.formStory.title]]),E]),e("div",N,[A,t.formStory.thumbnail?d((r(),l("img",q,null,512)),[[p,t.getPhoto(t.formStory.thumbnail).imageUrl]]):a("",!0),e("input",{type:"file",accept:"image/*",class:"form-control",onChange:i[3]||(i[3]=o=>t.handleThumbnailUpload(o,"thumbnail")),required:""},null,32)]),e("div",D,[R,t.formStory.image?(r(),l(c,{key:0},[u(" test "),d(e("img",J,null,512),[[p,t.getPhoto(t.formStory.image).imageUrl]])],64)):a("",!0),e("input",{type:"file",id:"image",accept:"image/*",class:"form-control",onChange:i[4]||(i[4]=o=>t.handleThumbnailUpload(o,"image")),required:""},null,32)]),e("div",W,[d(e("textarea",{"onUpdate:modelValue":i[5]||(i[5]=o=>t.formStory.description=o),class:"form-control",placeholder:"Введите описание",id:"description",style:{height:"150px"},required:""},null,512),[[g,t.formStory.description]]),G]),e("div",H,[d(e("input",{"onUpdate:modelValue":i[6]||(i[6]=o=>t.formStory.link=o),type:"url",class:"form-control",id:"title",placeholder:"Введите заголовок"},null,512),[[g,t.formStory.link]]),K]),t.formStory.link?(r(),l("div",Y,[d(e("select",{required:"","onUpdate:modelValue":i[7]||(i[7]=o=>t.formStory.link_type=o),class:"form-select",id:"link_type","aria-label":"Floating label select example"},[(r(!0),l(c,null,f(t.link_types,o=>(r(),l("option",{value:o.key},m(o.title),9,Q))),256))],512),[[_,t.formStory.link_type]]),X])):a("",!0)]),e("div",Z,[e("div",x,[d(e("input",{class:"form-check-input",type:"checkbox","onUpdate:modelValue":i[8]||(i[8]=o=>t.formStory.need_auto_send_stories=o),role:"switch",id:"script-settings-can_use_cash"},null,512),[[v,t.formStory.need_auto_send_stories]]),e("label",tt,[u("Автоматическая рассылка оповещения про новую историю: "),e("span",{class:h({"text-primary fw-bold":t.formStory.need_auto_send_stories})},"вкл",2),u(" \\ "),e("span",{class:h({"text-primary fw-bold":!t.formStory.need_auto_send_stories})},"выкл",2)])]),et])],32)])]),t.loadingStories?(r(),l("div",st,[u(" Подготавливаем данные... "),ot])):(r(),l(c,{key:1},[e("div",it,[(r(!0),l(c,null,f(t.stories,(o,y)=>(r(),l("div",{key:o.id,class:"col"},[e("div",rt,[e("div",lt,[e("div",{class:h(["story-item rounded-circle overflow-hidden cursor-pointer border mx-auto",{"border-primary":!t.isStoryViewed(o.id),"border-secondary":t.isStoryViewed(o.id)}]),style:{width:"80px",height:"80px"},onClick:S=>t.openStory(y)},[e("img",{src:o.thumbnail,class:h(["w-100 h-100 object-fit-cover",{"filter-grayscale":t.isStoryViewed(o.id)}]),alt:o.title},null,10,nt)],10,at),e("h5",dt,m(o.title),1),e("p",ct,m(o.description),1)]),e("div",mt,[e("button",{type:"button",class:"btn btn-link text-danger",onClick:S=>t.deleteStory(o.id)},"Удалить ",8,ut)])])]))),128))]),t.currentStory!==null?(r(),l("div",{key:0,class:"modal fade show d-block",style:{"background-color":"rgba(0, 0, 0, 0.9)"},onClick:i[12]||(i[12]=b((...o)=>t.closeStory&&t.closeStory(...o),["self"]))},[e("div",ht,[e("div",pt,[e("div",yt,[e("div",{class:"progress-bar bg-primary",role:"progressbar",style:k({width:`${t.progress}%`})},null,4)]),e("img",{src:t.stories[t.currentStory].image,class:"w-100 h-100 object-fit-cover",alt:"Story"},null,8,gt),e("div",bt,[e("h5",ft,m(t.stories[t.currentStory].title),1),e("p",St,m(t.stories[t.currentStory].description),1),t.stories[t.currentStory].link?(r(),l(c,{key:0},[t.stories[t.currentStory].link_type==="url"||t.stories[t.currentStory].link_type==="bot"?(r(),l("a",{key:0,href:t.stories[t.currentStory].link,target:"_blank",class:"btn btn-primary rounded-5 w-100 p-3"}," Перейти по ссылке ",8,_t)):a("",!0),t.stories[t.currentStory].link_type==="product"?(r(),l("a",{key:1,href:"javascript:void(0)",onClick:i[10]||(i[10]=o=>t.goToProductLink(t.stories[t.currentStory].link)),class:"btn btn-primary rounded-5 w-100 p-3"}," Открыть товар ")):a("",!0)],64)):a("",!0)]),e("button",{type:"button",class:"btn-close btn-close-white position-absolute top-0 end-0 m-2",style:{"z-index":"10"},onClick:i[11]||(i[11]=(...o)=>t.closeStory&&t.closeStory(...o))})])])])):a("",!0)],64)),t.stories_paginate_object?(r(),l(c,{key:2},[t.stories_paginate_object.meta.last_page>1?(r(),l("div",vt,[e("div",kt,[t.stories_paginate_object?(r(),w(M,{key:0,simple:!0,onPagination_page:t.nextStories,pagination:t.stories_paginate_object},null,8,["onPagination_page","pagination"])):a("",!0)])])):a("",!0)],64)):a("",!0)],64)}}}),Ct=U($t,[["__scopeId","data-v-f0be18d5"]]),jt={class:"container py-3"},Vt={class:"row"},It={class:"col-12"},Mt={data(){return{}},computed:{...V(["getSelf"]),currentBot(){return window.currentBot},tg(){return window.Telegram.WebApp}},mounted(){},methods:{}},Ot=Object.assign(Mt,{__name:"StoryManager",setup(s){return(t,i)=>(r(),l("div",jt,[e("div",Vt,[e("div",It,[I(Ct)])])]))}});export{Ot as default};
