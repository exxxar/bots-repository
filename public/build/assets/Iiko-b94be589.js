import{o as s,j as o,l as t,M as b,W as z,K as c,F as u,J as h,$ as g,a0 as F,n as f,L as m,a2 as $,N as x,G as C,k as V}from"./index.es-db843bab.js";import{_ as w}from"./_plugin-vue_export-helper-c27b6911.js";const j={props:["modelValue"],computed:{isComplete(){return this.iikoForm.api_login&&this.iikoForm.organization_id&&this.iikoForm.terminal_group_id},preparedTerminals(){let e=[];return this.terminals.forEach(i=>{i.items.forEach(n=>{e.push(n)})}),e}},data(){return{load:!1,token:null,selected_organization:null,selected_terminal:null,organizations:[],terminals:[],iikoForm:{id:null,bot_id:null,api_login:null,organization_id:null,terminal_group_id:null}}},watch:{iikoForm:{handler:function(e){this.$emit("update:modelValue",this.iikoForm)},deep:!0}},mounted(){this.modelValue&&this.$nextTick(()=>{this.iikoForm.id=this.modelValue.id||null,this.iikoForm.bot_id=this.modelValue.bot_id||null,this.iikoForm.api_login=this.modelValue.api_login||null,this.iikoForm.organization_id=this.modelValue.organization_id||null,this.iikoForm.terminal_group_id=this.modelValue.terminal_group_id||null,this.selected_terminal={name:this.iikoForm.terminal_group_id},this.selected_organization={name:this.iikoForm.organization_id},this.iikoForm.api_login&&this.getToken()})},methods:{selectOrganization(e){if(!e){this.selected_organization=null,this.iikoForm.organization_id=null,this.selected_terminal=null,this.iikoForm.terminal_group_id=null;return}this.selected_organization=e,this.iikoForm.organization_id=e.id,this.getTerminals()},selectTerminal(e){if(!e){this.selected_terminal=null,this.iikoForm.terminal_group_id=null;return}this.selected_terminal=e,this.iikoForm.terminal_group_id=e.id},changeApiLogin(){this.token=null,this.selectOrganization(null),this.selectTerminal(null),this.getToken()},getToken(){this.$store.dispatch("getIikoToken",{api_login:this.iikoForm.api_login}).then(e=>{this.token=e.token||null,this.getOrganizations()}).catch(e=>{this.$notify({title:"Упс!",text:"Ошибка получения токена",type:"error"})})},getOrganizations(){this.token&&this.$store.dispatch("getIikoOrganizations",{token:this.token}).then(e=>{this.organizations=e.organizations||[]}).catch(e=>{this.$notify({title:"Упс!",text:"Ошибка получения списка организаций",type:"error"})})},getTerminals(){!this.token||!this.iikoForm.organization_id||this.$store.dispatch("getIikoTerminals",{token:this.token,organization_id:this.iikoForm.organization_id}).then(e=>{this.terminals=e.terminals||[]}).catch(e=>{this.$notify({title:"Упс!",text:"Ошибка получения списка терминалов",type:"error"})})},submit(){let e=new FormData;Object.keys(this.iikoForm).forEach(i=>{const n=this.iikoForm[i]||"";typeof n=="object"?e.append(i,JSON.stringify(n)):e.append(i,n)}),this.$store.dispatch("storeIiko",{iikoForm:e}).then(i=>{this.$notify({title:"Отлично!",text:"Параметры успешно сохранены",type:"success"})}).catch(i=>{this.$notify({title:"Упс!",text:"Ошибка сохранения параметров",type:"error"})})}}},T={class:"form-floating mb-2"},M=t("label",{for:"iiko-form-api_login"},"API логин",-1),I=t("div",{class:"alert alert-light mb-2"}," Выберите организацию, которую хотите подключить ",-1),O={class:"dropdown mb-2"},B=["disabled"],E={key:0},P={key:1},L={class:"dropdown-menu w-100"},N=t("li",null,[t("hr",{class:"dropdown-divider p-0 m-0"})],-1),S=["onClick"],U={class:"text-wrap m-0"},A=t("div",{class:"alert alert-light mb-2"}," Выберите терминал в организации, через который будут проходить операции ",-1),D={class:"dropdown mb-2"},J=["disabled"],q={key:0},G={key:1},K={class:"dropdown-menu w-100"},W=t("li",null,[t("hr",{class:"dropdown-divider p-0 m-0"})],-1),H=["onClick"],Q=["disabled"];function R(e,i,n,_,l,a){return s(),o("form",{onSubmit:i[4]||(i[4]=F((...r)=>a.submit&&a.submit(...r),["prevent"]))},[t("div",T,[b(t("input",{type:"text","onUpdate:modelValue":i[0]||(i[0]=r=>l.iikoForm.api_login=r),onChange:i[1]||(i[1]=(...r)=>a.changeApiLogin&&a.changeApiLogin(...r)),class:"form-control",id:"iiko-form-api_login",placeholder:"name@example.com"},null,544),[[z,l.iikoForm.api_login]]),M]),I,t("div",O,[t("button",{type:"button",disabled:!l.token,class:"btn btn-outline-primary dropdown-toggle w-100 p-3",role:"button","data-bs-toggle":"dropdown","aria-expanded":"false"},[l.selected_organization?(s(),o("span",E,c(l.selected_organization.name||"не указан"),1)):(s(),o("span",P,"Не выбрано организации"))],8,B),t("ul",L,[t("li",null,[t("a",{class:"dropdown-item",onClick:i[2]||(i[2]=r=>a.selectOrganization(null)),href:"javascript:void(0)"},"Не выбрано")]),N,(s(!0),o(u,null,h(l.organizations,r=>(s(),o("li",null,[t("a",{class:g([{"bg-primary text-white":r.id==this.iikoForm.organization_id},"dropdown-item"]),onClick:d=>a.selectOrganization(r),href:"javascript:void(0)"},[t("p",U,c(r.name||"-")+" ("+c(r.restaurantAddress||"-")+")",1)],10,S)]))),256))])]),A,t("div",D,[t("button",{type:"button",disabled:!l.iikoForm.organization_id,class:"btn btn-outline-primary dropdown-toggle w-100 p-3",role:"button","data-bs-toggle":"dropdown","aria-expanded":"false"},[l.selected_terminal?(s(),o("span",q,c(l.selected_terminal.name||"не указан"),1)):(s(),o("span",G,"Не выбрано терминал"))],8,J),t("ul",K,[t("li",null,[t("a",{class:"dropdown-item",onClick:i[3]||(i[3]=r=>a.selectTerminal(null)),href:"javascript:void(0)"},"Не выбрано")]),W,(s(!0),o(u,null,h(a.preparedTerminals,r=>(s(),o("li",null,[t("a",{onClick:d=>a.selectTerminal(r),class:g([{"bg-primary text-white":r.id==this.iikoForm.terminal_group_id},"dropdown-item"]),href:"javascript:void(0)"},c(r.name||"-"),11,H)]))),256))])]),t("button",{class:"btn btn-primary p-3 w-100",disabled:!a.isComplete}," Сохранить настройки ",8,Q)],32)}const X=w(j,[["render",R]]),Y={data(){return{need_load_products:!1,selected_menu:null,selected_product:null,menus:[],categories:[],products:[]}},mounted(){this.getMenus()},methods:{selectProduct(e){this.selected_product=e,new bootstrap.Modal("#product-modal",{}).show()},selectMenu(e){this.selected_menu=e,this.getProducts()},getMenus(){this.$store.dispatch("getIikoMenu").then(e=>{this.menus=e.menus||[]}).catch(e=>{this.$notify({title:"Упс!",text:"Ошибка получения токена",type:"error"})})},getProducts(){this.need_load_products=!0,this.$store.dispatch("getIikoProducts",{menu_id:(this.selected_menu||{id:null}).id}).then(e=>{this.products=e.products.itemCategories||[],this.categories=e.products.productCategories||[],this.products.forEach(i=>{i.items.forEach(n=>{n.need_add=!0})}),this.need_load_products=!1}).catch(e=>{this.need_load_products=!1,this.$notify({title:"Упс!",text:"Ошибка получения токена",type:"error"})})},submit(){let e=[];this.products.forEach(i=>{i.items.forEach(n=>{e.push({id:n.itemId||null,sku:n.sku||null,name:n.name||null,description:n.description||null,category:i.name,in_stop:!n.need_add,price:n.itemSizes[0].prices[0].price||0,image:n.itemSizes[0].buttonImageUrl||null})})}),this.$store.dispatch("storeIikoProducts",{products:e}).then(i=>{this.$notify({title:"Отлично!",text:"Товары и категории успешно сохранены",type:"success"})}).catch(i=>{this.$notify({title:"Упс!",text:"Ошибка сохранения параметров",type:"error"})})}}},Z={key:0,class:"list-group"},tt=["onClick"],et={class:"badge bg-primary mr-2"},it={key:1,class:"alert alert-light my-2 d-flex justify-content-center align-items-center",role:"alert"},st=t("div",{class:"d-flex justify-content-center align-items-center flex-column"},[t("div",{class:"spinner-grow text-primary my-3",role:"status"},[t("span",{class:"visually-hidden"},"Загружаем....")]),t("p",null,"Загружаем список меню...")],-1),ot=[st],nt={key:2,class:"mt-3 mb-0 p-0"},lt={class:"my-2"},rt={class:"list-group"},at={class:"list-group-item d-flex justify-content-between align-items-center"},dt={class:"form-check"},ct=["onUpdate:modelValue","id"],ut=["for"],mt=["onClick"],ht={key:4,class:"alert alert-light my-2 d-flex justify-content-center align-items-center",role:"alert"},_t=t("div",{class:"d-flex justify-content-center align-items-center flex-column"},[t("div",{class:"spinner-grow text-primary my-3",role:"status"},[t("span",{class:"visually-hidden"},"Загружаем....")]),t("p",null,"Загружаем список товаров из меню...")],-1),pt=[_t],gt={class:"modal fade",id:"product-modal",tabindex:"-1","aria-labelledby":"exampleModalLabel","aria-hidden":"true"},kt={class:"modal-dialog modal-fullscreen"},ft={class:"modal-content"},bt=t("div",{class:"modal-header"},[t("h1",{class:"modal-title fs-5",id:"exampleModalLabel"},"Редактор"),t("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})],-1),yt={key:0,class:"modal-body"},vt={class:"img-fluid",alt:""},wt={class:"my-2"},zt={class:"fw-bold"};function Ft(e,i,n,_,l,a){const r=x("lazy");return s(),o(u,null,[l.menus.length>0?(s(),o("ul",Z,[(s(!0),o(u,null,h(l.menus,d=>(s(),o("li",{onClick:p=>a.selectMenu(d),class:g([{active:(this.selected_menu||{id:null}).id==d.id},"list-group-item"])},[t("span",et,"#"+c(d.id),1),f(c(d.name),1)],10,tt))),256))])):(s(),o("div",it,ot)),l.products.length>0?(s(),o("hr",nt)):m("",!0),l.products.length>0?(s(!0),o(u,{key:3},h(l.products,(d,p)=>(s(),o(u,null,[t("h6",lt,c(d.name),1),t("ul",rt,[(s(!0),o(u,null,h(d.items,(k,y)=>(s(),o("li",at,[t("div",dt,[b(t("input",{class:"form-check-input","onUpdate:modelValue":v=>l.products[p].items[y].need_add=v,type:"checkbox",value:"",id:"product-"+k.id},null,8,ct),[[$,l.products[p].items[y].need_add]]),t("label",{class:"form-check-label",for:"product-"+k.id},c(k.name||"-"),9,ut)]),t("i",{onClick:v=>a.selectProduct(k),class:"fa-solid fa-arrow-up-right-from-square"},null,8,mt)]))),256))])],64))),256)):m("",!0),l.need_load_products?(s(),o("div",ht,pt)):m("",!0),l.products.length>0?(s(),o("button",{key:5,onClick:i[0]||(i[0]=(...d)=>a.submit&&a.submit(...d)),style:{"z-index":"100",bottom:"10px"},type:"button",class:"btn btn-primary w-100 p-3 my-3 position-sticky"},"Сохранить товары ")):m("",!0),t("div",gt,[t("div",kt,[t("div",ft,[bt,l.selected_product?(s(),o("div",yt,[t("h6",null,c(l.selected_product.name||"Нет имени"),1),t("p",null,c(l.selected_product.description||"Нет описания"),1),(s(!0),o(u,null,h(l.selected_product.itemSizes,d=>(s(),o(u,null,[b(t("img",vt,null,512),[[r,d.buttonImageUrl]]),t("p",wt,[f(" Цена "),(s(!0),o(u,null,h(d.prices,p=>(s(),o("span",zt,c(p.price||0)+" ₽",1))),256))])],64))),256))])):m("",!0)])])])],64)}const $t=w(Y,[["render",Ft]]),xt={class:"container py-3"},Ct={class:"row"},Vt={class:"col-12"},jt={class:"nav nav-tabs d-flex justify-content-center mb-2"},Tt={class:"nav-item"},Mt=t("i",{class:"fa-solid fa-gears"},null,-1),It={class:"nav-item"},Ot=t("i",{class:"fa-brands fa-shopify"},null,-1),Bt={key:0,class:"col-12"},Et={key:1,class:"col-12"},Pt={data(){return{tab:0,load:!1}},computed:{currentBot(){return window.currentBot||null}},mounted(){},methods:{}},St=Object.assign(Pt,{__name:"Iiko",setup(e){return(i,n)=>(s(),o("div",xt,[t("div",Ct,[t("div",Vt,[t("ul",jt,[t("li",Tt,[t("a",{class:g(["nav-link",{active:i.tab===0}]),onClick:n[0]||(n[0]=_=>i.tab=0),"aria-current":"page",href:"javascript:void(0)"},[Mt,f(" Настройка")],2)]),t("li",It,[t("a",{class:g(["nav-link",{active:i.tab===1}]),onClick:n[1]||(n[1]=_=>i.tab=1),href:"javascript:void(0)"},[Ot,f(" Продукты")],2)])])]),i.tab===0?(s(),o("div",Bt,[!i.load&&i.currentBot?(s(),C(X,{key:0,modelValue:i.currentBot.iiko,"onUpdate:modelValue":n[2]||(n[2]=_=>i.currentBot.iiko=_)},null,8,["modelValue"])):m("",!0)])):m("",!0),i.tab===1?(s(),o("div",Et,[V($t)])):m("",!0)])]))}});export{St as default};
